import{r as l,j as e}from"./index-DXtarUcJ.js";import"./react-vendor-DS08_OVb.js";import"./pdf-vendor-B1Z1FYJ2.js";const he=["https://huggingface.co/andraniksargsyan/migan/resolve/main/migan_pipeline_v2.onnx","https://huggingface.co/lxfater/inpaint-web/resolve/main/migan.onnx"],ge="freetool-inpaint",I="models",K="migan-pipeline-v2";function V(){return new Promise((s,n)=>{const r=indexedDB.open(ge,1);r.onerror=()=>n(r.error),r.onsuccess=()=>s(r.result),r.onupgradeneeded=h=>{const i=h.target.result;i.objectStoreNames.contains(I)||i.createObjectStore(I)}})}async function H(){try{const s=await V();return new Promise((n,r)=>{const u=s.transaction(I,"readonly").objectStore(I).get(K);u.onerror=()=>r(u.error),u.onsuccess=()=>n(u.result||null)})}catch(s){return console.error("Failed to get model from cache:",s),null}}async function me(s){try{const n=await V();return new Promise((r,h)=>{const c=n.transaction(I,"readwrite").objectStore(I).put(s,K);c.onerror=()=>h(c.error),c.onsuccess=()=>r()})}catch(n){console.error("Failed to save model to cache:",n)}}async function $(s){var r;const n=await H();if(n)return s==null||s(100,n.byteLength,n.byteLength),n;for(const h of he)try{const i=await fetch(h);if(!i.ok)continue;const u=Number(i.headers.get("content-length"))||0,c=(r=i.body)==null?void 0:r.getReader();if(!c)continue;const g=[];let x=0;for(;;){const{done:p,value:j}=await c.read();if(p)break;g.push(j),x+=j.length,u>0&&(s==null||s(Math.round(x/u*100),x,u))}const m=new Uint8Array(x);let v=0;for(const p of g)m.set(p,v),v+=p.length;const f=m.buffer;return await me(f),f}catch(i){console.error(`Failed to download from ${h}:`,i);continue}throw new Error("Failed to download model from all URLs")}let T=null;async function W(s){if(T)return T;const n=await $(s),r=window.ort,h={executionProviders:["wasm"],graphOptimizationLevel:"all"};return T=await r.InferenceSession.create(n,h),T}function xe(s){const{width:n,height:r,data:h}=s,i=new Uint8Array(3*r*n);for(let u=0;u<3;u++)for(let c=0;c<r;c++)for(let g=0;g<n;g++){const x=(c*n+g)*4+u,m=u*r*n+c*n+g;i[m]=h[x]}return i}function fe(s){const{width:n,height:r,data:h}=s,i=new Uint8Array(r*n);for(let u=0;u<r;u++)for(let c=0;c<n;c++){const g=(u*n+c)*4,x=u*n+c;i[x]=h[g]!==255?255:0}return i}function pe(s,n,r){const h=new ImageData(n,r),i=h.data,u=n*r;for(let c=0;c<r;c++)for(let g=0;g<n;g++){const x=(c*n+g)*4;for(let m=0;m<3;m++){const v=m*u+c*n+g;let f=s[v];f>255&&(f=255),f<0&&(f=0),i[x+m]=f}i[x+3]=255}return h}async function be(s,n,r){const h=s.width,i=s.height;r==null||r("正在准备图像...");const u=xe(s),c=fe(n);r==null||r("正在运行 AI 模型...");const g=await W(),x=window.ort,m=g.inputNames,v=g.outputNames;console.log("Model input names:",m),console.log("Model output names:",v);const f=new x.Tensor("uint8",u,[1,3,i,h]),p=new x.Tensor("uint8",c,[1,1,i,h]),j={};j[m[0]]=f,j[m[1]]=p;const w=(await g.run(j))[v[0]].data;return r==null||r("正在处理结果..."),pe(w,h,i)}async function ye(){return await H()!==null}const je=()=>{const[s,n]=l.useState(null),[r,h]=l.useState(""),[i,u]=l.useState(""),[c,g]=l.useState("idle"),[x,m]=l.useState(""),[v,f]=l.useState(0),[p,j]=l.useState(30),[y,w]=l.useState([]),[D,F]=l.useState(!1),[B,z]=l.useState(null),[N,E]=l.useState(""),[M,R]=l.useState(!1),[L,O]=l.useState(!1),[Y,k]=l.useState(null),A=l.useRef(null);l.useRef(null);const Q=l.useRef(null);l.useEffect(()=>{ye().then(O)},[]);const Z=l.useCallback(a=>{var b;const t=(b=a.target.files)==null?void 0:b[0];if(!t)return;if(!t.type.startsWith("image/")){k("请选择图片文件");return}k(null),u(t.name),w([]),E(""),R(!1);const o=URL.createObjectURL(t),d=new Image;d.onload=()=>{n(d),h(o)},d.src=o},[]),P=l.useCallback(a=>{a.preventDefault();const t=a.dataTransfer.files[0];if(!t||!t.type.startsWith("image/")){k("请拖入图片文件");return}k(null),u(t.name),w([]),E(""),R(!1);const o=URL.createObjectURL(t),d=new Image;d.onload=()=>{n(d),h(o)},d.src=o},[]);l.useEffect(()=>{if(!A.current||!s)return;const a=A.current,t=a.getContext("2d");t&&(a.width=s.width,a.height=s.height,t.drawImage(s,0,0),t.globalCompositeOperation="source-over",y.forEach(o=>{if(!(o.points.length<2)){t.beginPath(),t.strokeStyle="rgba(255, 0, 0, 0.5)",t.lineWidth=o.brushSize,t.lineCap="round",t.lineJoin="round",t.moveTo(o.points[0].x,o.points[0].y);for(let d=1;d<o.points.length;d++)t.lineTo(o.points[d].x,o.points[d].y);t.stroke()}}),B&&!D&&(t.beginPath(),t.strokeStyle="rgba(255, 0, 0, 0.8)",t.lineWidth=2,t.arc(B.x,B.y,p/2,0,Math.PI*2),t.stroke()))},[s,y,B,p,D]);const U=l.useCallback(a=>{if(!A.current||!s)return null;const o=A.current.getBoundingClientRect(),d=s.width/o.width,b=s.height/o.height;let C,S;return"touches"in a?(C=a.touches[0].clientX,S=a.touches[0].clientY):(C=a.clientX,S=a.clientY),{x:(C-o.left)*d,y:(S-o.top)*b}},[s]),X=l.useCallback(a=>{const t=U(a);t&&(F(!0),w(o=>[...o,{points:[t],brushSize:p}]))},[U,p]),q=l.useCallback(a=>{const t=U(a);t&&(z(t),D&&w(o=>{const d=[...o],b=d[d.length-1];return b&&b.points.push(t),d}))},[D,U]),J=l.useCallback(()=>{F(!1)},[]),ee=l.useCallback(()=>{F(!1),z(null)},[]),te=l.useCallback(()=>{w(a=>a.slice(0,-1))},[]),ae=l.useCallback(()=>{w([])},[]);l.useCallback(async()=>{g("loading-model"),m("正在下载模型..."),k(null);try{await $((a,t,o)=>{f(a);const d=(t/1024/1024).toFixed(1),b=(o/1024/1024).toFixed(1);m(`正在下载模型... ${d}MB / ${b}MB`)}),m("正在初始化模型..."),await W(),g("ready"),m(""),O(!0)}catch(a){console.error("Model loading failed:",a),k("模型加载失败，请检查网络后重试"),g("idle")}},[]);const G=l.useCallback(()=>{if(!s||y.length===0)return null;const a=document.createElement("canvas");a.width=s.width,a.height=s.height;const t=a.getContext("2d");return t?(t.fillStyle="black",t.fillRect(0,0,a.width,a.height),t.strokeStyle="white",t.fillStyle="white",t.lineCap="round",t.lineJoin="round",y.forEach(o=>{if(!(o.points.length<2)){t.beginPath(),t.lineWidth=o.brushSize,t.moveTo(o.points[0].x,o.points[0].y);for(let d=1;d<o.points.length;d++)t.lineTo(o.points[d].x,o.points[d].y);t.stroke()}}),t.getImageData(0,0,a.width,a.height)):null},[s,y]),se=l.useCallback(async()=>{if(!s||y.length===0){k("请先用画笔标记需要去除的区域");return}g("processing"),k(null);try{L||(m("正在下载 AI 模型..."),await $((_,ce,ie)=>{f(_);const de=(ce/1024/1024).toFixed(1),ue=(ie/1024/1024).toFixed(1);m(`正在下载 AI 模型... ${de}MB / ${ue}MB`)}),O(!0)),m("正在初始化模型..."),await W(),m("正在准备图像...");const a=document.createElement("canvas");a.width=s.width,a.height=s.height;const t=a.getContext("2d");if(!t)throw new Error("Canvas context error");t.drawImage(s,0,0);const o=t.getImageData(0,0,s.width,s.height),d=G();if(!d)throw new Error("Mask generation error");const b=await be(o,d,_=>{m(_)}),C=document.createElement("canvas");C.width=b.width,C.height=b.height;const S=C.getContext("2d");if(!S)throw new Error("Result canvas error");S.putImageData(b,0,0);const le=C.toDataURL("image/png");E(le),R(!0),g("ready"),m("")}catch(a){console.error("Processing failed:",a),k("处理失败: "+(a instanceof Error?a.message:"未知错误")),g("idle"),m("")}},[s,y,L,G]),ne=l.useCallback(()=>{if(!N)return;const a=document.createElement("a");a.href=N;const t=i.replace(/\.[^/.]+$/,"");a.download=`${t}_no_watermark.png`,document.body.appendChild(a),a.click(),document.body.removeChild(a)},[N,i]),re=l.useCallback(()=>{if(!N)return;const a=new Image;a.onload=()=>{n(a),h(N),w([]),R(!1),E("")},a.src=N},[N]),oe=l.useCallback(()=>{n(null),h(""),u(""),w([]),E(""),R(!1),k(null)},[]);return e.jsxs("div",{className:"flex w-full flex-col items-center px-4 py-10 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"flex w-full max-w-6xl flex-col items-center gap-2 text-center mb-8",children:[e.jsx("p",{className:"text-3xl font-black leading-tight tracking-tighter text-gray-900 dark:text-white sm:text-4xl",children:"图片水印去除"}),e.jsx("p",{className:"text-base font-normal text-gray-500 dark:text-gray-400",children:"使用 AI 智能移除图片中的水印、文字等不需要的内容"})]}),e.jsxs("div",{className:"w-full max-w-6xl flex flex-col gap-6",children:[Y&&e.jsx("div",{className:"bg-red-100 dark:bg-red-900/50 border border-red-200 dark:border-red-800 rounded-lg p-4",children:e.jsx("p",{className:"text-red-800 dark:text-red-300 text-sm",children:Y})}),e.jsx("div",{className:"w-full rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-background-dark shadow-sm",children:s?e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3",children:[e.jsxs("div",{ref:Q,className:"relative flex flex-col p-6 border-b lg:border-b-0 lg:border-r border-gray-200 dark:border-gray-700/50 lg:col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-gray-900 dark:text-white text-base font-semibold leading-normal flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-xl",children:"brush"}),M?"处理结果":"用画笔涂抹水印区域"]}),e.jsx("button",{onClick:oe,className:"text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300",children:"更换图片"})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700 p-4 min-h-[400px] overflow-auto",children:M?e.jsx("img",{src:N,alt:"Result",className:"max-w-full max-h-[500px] object-contain"}):e.jsx("canvas",{ref:A,className:"max-w-full max-h-[500px] object-contain cursor-none",style:{touchAction:"none"},onMouseDown:X,onMouseMove:q,onMouseUp:J,onMouseLeave:ee,onTouchStart:X,onTouchMove:q,onTouchEnd:J})}),i&&e.jsx("p",{className:"mt-2 text-xs text-gray-500 dark:text-gray-400 text-center",children:i})]}),e.jsxs("div",{className:"relative flex flex-col p-6 bg-gray-50/50 dark:bg-gray-800/30 gap-4",children:[!M&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between px-1",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:"画笔大小"}),e.jsxs("span",{className:"text-sm font-medium text-primary",children:[p,"px"]})]}),e.jsx("input",{type:"range",min:"5",max:"100",value:p,onChange:a=>j(Number(a.target.value)),className:"w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer accent-primary"})]}),!M&&y.length>0&&e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:te,className:"flex-1 flex items-center justify-center gap-2 h-10 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"undo"}),e.jsx("span",{className:"text-sm font-medium",children:"撤销"})]}),e.jsxs("button",{onClick:ae,className:"flex-1 flex items-center justify-center gap-2 h-10 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",children:[e.jsx("span",{className:"material-symbols-outlined text-lg",children:"delete"}),e.jsx("span",{className:"text-sm font-medium",children:"清除"})]})]}),c==="loading-model"&&e.jsxs("div",{className:"space-y-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"spinner",style:{borderTopColor:"#607AFB"}}),e.jsx("span",{className:"text-sm text-blue-700 dark:text-blue-300",children:x})]}),e.jsx("div",{className:"w-full h-2 bg-blue-200 dark:bg-blue-800 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary transition-all duration-300",style:{width:`${v}%`}})})]}),c==="processing"&&e.jsx("div",{className:"space-y-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"spinner",style:{borderTopColor:"#607AFB"}}),e.jsx("span",{className:"text-sm text-blue-700 dark:text-blue-300",children:x||"正在处理..."})]})}),M?e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("button",{onClick:ne,style:{backgroundColor:"#607AFB"},className:"flex h-11 w-full cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg px-6 text-sm font-bold text-white shadow-lg transition-opacity hover:opacity-90",children:[e.jsx("span",{className:"material-symbols-outlined",children:"download"}),e.jsx("span",{children:"下载结果"})]}),e.jsxs("button",{onClick:re,className:"flex h-11 w-full cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg px-6 text-sm font-bold bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",children:[e.jsx("span",{className:"material-symbols-outlined",children:"edit"}),e.jsx("span",{children:"继续编辑"})]})]}):e.jsxs("button",{onClick:se,disabled:c==="loading-model"||c==="processing"||y.length===0,style:{backgroundColor:"#607AFB"},className:"flex h-11 w-full cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg px-6 text-sm font-bold text-white shadow-lg transition-opacity hover:opacity-90 disabled:cursor-not-allowed disabled:opacity-50",children:[e.jsx("span",{className:"material-symbols-outlined",children:"auto_fix_high"}),e.jsx("span",{children:L?"开始处理":"加载模型并处理"})]}),!M&&e.jsx("div",{className:"p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg",children:e.jsxs("p",{className:"text-xs text-amber-700 dark:text-amber-300",children:[e.jsx("strong",{children:"使用说明："}),"用画笔涂抹需要去除的水印区域（显示为红色），然后点击处理按钮。首次使用需下载约 27MB 的 AI 模型。"]})}),L&&c==="idle"&&e.jsx("div",{className:"p-3 bg-green-50 dark:bg-green-900/20 rounded-lg",children:e.jsxs("p",{className:"text-xs text-green-700 dark:text-green-300",children:[e.jsx("strong",{children:"模型已缓存"})," - 无需重新下载"]})})]})]}):e.jsxs("label",{className:"flex flex-col items-center gap-6 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-700 p-8 sm:p-14 text-center cursor-pointer hover:border-primary dark:hover:border-primary transition-colors m-6",onDragOver:a=>a.preventDefault(),onDrop:P,children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-gray-400 dark:text-gray-500",children:"healing"}),e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("p",{className:"text-lg font-bold text-gray-900 dark:text-white",children:"拖拽图片至此"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"支持 JPG, PNG, WebP 等格式"})]}),e.jsx("span",{className:"flex h-10 min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-gray-100 dark:bg-white/10 px-4 text-sm font-bold text-gray-800 dark:text-white transition-colors hover:bg-gray-200 dark:hover:bg-white/20",children:"点击选择文件"}),e.jsx("input",{type:"file",accept:"image/*",onChange:Z,className:"hidden"})]})})]})]})};export{je as default};
