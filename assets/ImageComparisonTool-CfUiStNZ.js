import{r as p,R as D,j as s}from"./index-k8Rc8_e6.js";import"./react-vendor-DS08_OVb.js";import"./pdf-vendor-B1Z1FYJ2.js";const re=()=>{const[m,w]=p.useState([]),[f,j]=p.useState(null),[T,E]=p.useState(!1),[z,$]=p.useState(null),[R,P]=p.useState(null),[v,Z]=p.useState({width:1200,height:800}),[I,F]=p.useState(!1),L=p.useRef(null),A=p.useRef(null),C=p.useRef(new Map),M=p.useRef(null),W=p.useCallback(()=>{const t=L.current;if(!t)return;const e=t.getContext("2d");if(!e)return;e.fillStyle="#f0f0f0",e.fillRect(0,0,t.width,t.height);const a=20;for(let n=0;n<t.width;n+=a)for(let r=0;r<t.height;r+=a)(n/a+r/a)%2===0?e.fillStyle="#ffffff":e.fillStyle="#e0e0e0",e.fillRect(n,r,a,a);[...m].sort((n,r)=>n.zIndex-r.zIndex).forEach(n=>{if(n.visible){if(e.save(),e.globalAlpha=n.opacity,n.type==="image"){const r=n;let i=C.current.get(r.id);if(i||(i=new Image,i.src=r.src,C.current.set(r.id,i)),e.translate(r.x+r.width/2,r.y+r.height/2),e.rotate(r.rotation*Math.PI/180),e.drawImage(i,-r.width/2,-r.height/2,r.width,r.height),f===n.id){e.strokeStyle="#00FF00",e.lineWidth=2,e.strokeRect(-r.width/2,-r.height/2,r.width,r.height);const l=8;e.fillStyle="#00FF00",e.fillRect(-r.width/2-l/2,-r.height/2-l/2,l,l),e.fillRect(r.width/2-l/2,-r.height/2-l/2,l,l),e.fillRect(-r.width/2-l/2,r.height/2-l/2,l,l),e.fillRect(r.width/2-l/2,r.height/2-l/2,l,l)}}else if(n.type==="text"){const r=n;if(e.translate(r.x,r.y),e.rotate(r.rotation*Math.PI/180),e.font=`${r.fontSize}px ${r.fontFamily}`,e.fillStyle=r.color,e.fillText(r.text,0,0),f===n.id){const i=e.measureText(r.text);e.strokeStyle="#00FF00",e.lineWidth=2,e.strokeRect(-5,-r.fontSize-5,i.width+10,r.fontSize+10)}}e.restore()}})},[m,f]);D.useEffect(()=>{W()},[W]);const X=t=>{const e=t.target.files;e&&(Array.from(e).forEach((a,d)=>{const n=new FileReader;n.onload=r=>{var l;const i=new Image;i.onload=()=>{var g;const c=v.width*.8,x=v.height*.8;let h=i.width,b=i.height,k=1;if(h>c||b>x){const o=c/h,y=x/b;k=Math.min(o,y),h=i.width*k,b=i.height*k}const S={id:Date.now().toString()+d,type:"image",name:`图片 ${m.length+d+1}`,src:(g=r.target)==null?void 0:g.result,visible:!0,locked:!1,x:50+d*30,y:50+d*30,width:h,height:b,originalWidth:i.width,originalHeight:i.height,scale:k,rotation:0,opacity:1,zIndex:m.length+d};w(o=>[...o,S]),C.current.set(S.id,i)},i.src=(l=r.target)==null?void 0:l.result},n.readAsDataURL(a)}),t.target.value="")},Y=(t,e=0)=>{const a=new Image;a.onload=()=>{const d=v.width*.8,n=v.height*.8;let r=a.width,i=a.height,l=1;if(r>d||i>n){const x=d/r,h=n/i;l=Math.min(x,h),r=a.width*l,i=a.height*l}const c={id:Date.now().toString()+e,type:"image",name:`粘贴图片 ${m.length+e+1}`,src:t,visible:!0,locked:!1,x:50+e*30,y:50+e*30,width:r,height:i,originalWidth:a.width,originalHeight:a.height,scale:l,rotation:0,opacity:1,zIndex:m.length+e};w(x=>[...x,c]),C.current.set(c.id,a)},a.src=t},B=()=>{const t={id:Date.now().toString(),type:"text",name:`文本 ${m.filter(e=>e.type==="text").length+1}`,text:"文本内容",visible:!0,locked:!1,x:v.width/2,y:v.height/2,fontSize:32,fontFamily:"Arial",color:"#000000",rotation:0,opacity:1,zIndex:m.length};w(e=>[...e,t]),j(t.id)},_=t=>{const e=L.current;if(!e)return{x:0,y:0};const a=e.getBoundingClientRect(),d=e.width/a.width,n=e.height/a.height;return{x:(t.clientX-a.left)*d,y:(t.clientY-a.top)*n}},O=(t,e)=>{const a=[...m].sort((d,n)=>n.zIndex-d.zIndex);for(const d of a)if(!(!d.visible||d.locked)){if(d.type==="image"){const n=d;if(t>=n.x&&t<=n.x+n.width&&e>=n.y&&e<=n.y+n.height)return d}else if(d.type==="text"){const n=d,r=L.current;if(!r)continue;const i=r.getContext("2d");if(!i)continue;i.font=`${n.fontSize}px ${n.fontFamily}`;const l=i.measureText(n.text),c=n.x-5,x=n.y-n.fontSize-5,h=l.width+10,b=n.fontSize+10;if(t>=c&&t<=c+h&&e>=x&&e<=x+b)return d}}return null},V=t=>{const e=_(t),a=O(e.x,e.y);a&&!a.locked?(j(a.id),E(!0),$(e),P({x:a.x,y:a.y})):j(null)},q=t=>{if(!T||!z||!f||!R)return;const e=m.find(r=>r.id===f);if(e!=null&&e.locked)return;const a=_(t),d=a.x-z.x,n=a.y-z.y;w(r=>r.map(i=>i.id===f&&!i.locked?{...i,x:R.x+d,y:R.y+n}:i))},H=()=>{E(!1),$(null),P(null)},G=t=>{w(e=>e.map(a=>a.id===t?{...a,visible:!a.visible}:a))},J=t=>{w(e=>e.map(a=>{if(a.id===t){const d=!a.locked;return d&&f===t&&j(null),{...a,locked:d}}return a}))},K=t=>{w(e=>e.filter(a=>a.id!==t)),f===t&&j(null)},U=(t,e)=>{w(a=>{if(!a.find(l=>l.id===t))return a;const n=[...a].sort((l,c)=>l.zIndex-c.zIndex),r=n.findIndex(l=>l.id===t);if(r===-1)return a;const i=[...a];if(e==="up"&&r<n.length-1){const l=n[r+1],c=a.findIndex(h=>h.id===t),x=a.findIndex(h=>h.id===l.id);[i[c].zIndex,i[x].zIndex]=[i[x].zIndex,i[c].zIndex]}else if(e==="down"&&r>0){const l=n[r-1],c=a.findIndex(h=>h.id===t),x=a.findIndex(h=>h.id===l.id);[i[c].zIndex,i[x].zIndex]=[i[x].zIndex,i[c].zIndex]}return i})},N=t=>{f&&w(e=>e.map(a=>a.id===f?{...a,...t}:a))};D.useEffect(()=>{const t=async e=>{var d;e.preventDefault();const a=(d=e.clipboardData)==null?void 0:d.items;if(a)for(let n=0;n<a.length;n++){const r=a[n];if(r.type.indexOf("image")!==-1){const i=r.getAsFile();if(!i)continue;const l=new FileReader;l.onload=c=>{var h;const x=(h=c.target)==null?void 0:h.result;Y(x,n)},l.readAsDataURL(i)}}};return document.addEventListener("paste",t),()=>{document.removeEventListener("paste",t)}},[m,v]);const Q=async()=>{if(M.current)try{document.fullscreenElement?(await document.exitFullscreen(),F(!1)):(await M.current.requestFullscreen(),F(!0))}catch(t){console.error("全屏切换失败:",t)}};D.useEffect(()=>{const t=()=>{F(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",t),()=>{document.removeEventListener("fullscreenchange",t)}},[]);const u=m.find(t=>t.id===f);return s.jsx("div",{className:"flex w-full flex-col items-center px-4 py-10 sm:px-6 lg:px-8",children:s.jsxs("div",{className:"flex flex-col gap-8",children:[s.jsxs("div",{className:"flex w-full max-w-7xl flex-col items-center gap-2 text-center mb-8",children:[s.jsx("p",{className:"text-3xl font-black leading-tight tracking-tighter text-gray-900 dark:text-white sm:text-4xl",children:"多图自由拼接"}),s.jsx("p",{className:"text-base font-normal text-gray-500 dark:text-gray-400",children:"在一个画布中导入多张图片，支持图层管理、位置调整和文本添加。"})]}),s.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[1fr_320px] gap-6 items-start",children:[s.jsxs("div",{ref:M,className:"rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-background-dark p-6 shadow-sm flex flex-col gap-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"画布"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("button",{onClick:Q,className:"flex items-center gap-1 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800",title:I?"退出全屏":"全屏显示",children:[s.jsx("span",{className:"material-symbols-outlined text-base",children:I?"fullscreen_exit":"fullscreen"}),I?"退出全屏":"全屏"]}),s.jsxs("button",{onClick:()=>{var t;return(t=A.current)==null?void 0:t.click()},className:"flex items-center gap-1 px-3 py-1.5 rounded-lg bg-primary text-white text-sm font-medium hover:opacity-90",style:{backgroundColor:"#607AFB"},children:[s.jsx("span",{className:"material-symbols-outlined text-base",children:"add_photo_alternate"}),"添加图片"]}),s.jsxs("button",{onClick:B,className:"flex items-center gap-1 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800",children:[s.jsx("span",{className:"material-symbols-outlined text-base",children:"text_fields"}),"添加文本"]}),s.jsx("input",{ref:A,type:"file",accept:"image/*",multiple:!0,onChange:X,className:"hidden"})]})]}),s.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1",children:[s.jsx("span",{className:"material-symbols-outlined text-sm",children:"info"}),"提示：按 Ctrl/Cmd+V 可直接粘贴图片"]}),s.jsx("div",{className:`flex-1 flex items-center justify-center bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700 p-4 overflow-auto ${I?"h-screen":""}`,children:s.jsx("canvas",{ref:L,width:v.width,height:v.height,onMouseDown:V,onMouseMove:q,onMouseUp:H,onMouseLeave:H,className:`cursor-move shadow-lg ${I?"max-w-full max-h-full":"max-w-full max-h-[600px]"}`})}),u&&s.jsxs("div",{className:"p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg space-y-3",children:[s.jsxs("h4",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:["当前选中: ",u.name]}),u.type==="image"&&s.jsx("div",{className:"space-y-2",children:s.jsxs("div",{children:[s.jsxs("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1 block",children:["缩放: ",Math.round(u.scale*100),"%"]}),s.jsx("input",{type:"range",min:"10",max:"200",value:u.scale*100,onChange:t=>{const e=parseFloat(t.target.value)/100,a=u;N({scale:e,width:a.originalWidth*e,height:a.originalHeight*e})},className:"w-full"})]})}),u.type==="text"&&s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{children:[s.jsx("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1 block",children:"文本内容"}),s.jsx("input",{type:"text",value:u.text,onChange:t=>N({text:t.target.value}),className:"w-full px-2 py-1 rounded border border-gray-300 dark:border-gray-700 bg-transparent text-sm",placeholder:"输入文本内容"})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1 block",children:["字体大小: ",u.fontSize,"px"]}),s.jsx("input",{type:"range",min:"12",max:"120",value:u.fontSize,onChange:t=>N({fontSize:parseInt(t.target.value)}),className:"w-full"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1 block",children:"颜色"}),s.jsx("input",{type:"color",value:u.color,onChange:t=>N({color:t.target.value}),className:"w-full h-8 rounded cursor-pointer"})]})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1 block",children:["旋转: ",u.rotation,"°"]}),s.jsx("input",{type:"range",min:"0",max:"360",value:u.rotation,onChange:t=>N({rotation:parseInt(t.target.value)}),className:"w-full"})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1 block",children:["不透明度: ",Math.round(u.opacity*100),"%"]}),s.jsx("input",{type:"range",min:"0",max:"100",value:u.opacity*100,onChange:t=>N({opacity:parseFloat(t.target.value)/100}),className:"w-full"})]})]})]}),s.jsx("div",{className:"rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-background-dark p-6 shadow-sm",children:s.jsxs("div",{className:"flex flex-col gap-4 min-h-[680px]",children:[s.jsx("h3",{className:"text-base font-semibold text-gray-900 dark:text-white",children:"图层"}),m.length===0?s.jsx("div",{className:"flex-1 flex items-center justify-center text-center text-gray-500 dark:text-gray-400 text-sm",children:s.jsxs("div",{className:"space-y-2",children:[s.jsx("span",{className:"material-symbols-outlined text-4xl",children:"layers"}),s.jsx("p",{children:"暂无图层"}),s.jsx("p",{className:"text-xs",children:"点击上方按钮添加图片或文本"})]})}):s.jsx("div",{className:"flex-1 overflow-y-auto space-y-2",children:[...m].sort((t,e)=>e.zIndex-t.zIndex).map(t=>s.jsxs("div",{className:`p-3 rounded-lg border transition-all ${t.locked?"cursor-not-allowed opacity-60":"cursor-pointer"} ${f===t.id?"border-primary bg-primary/10":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"}`,onClick:()=>!t.locked&&j(t.id),children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx("button",{onClick:e=>{e.stopPropagation(),G(t.id)},className:"text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white",title:t.visible?"隐藏":"显示",children:s.jsx("span",{className:"material-symbols-outlined text-base",children:t.visible?"visibility":"visibility_off"})}),s.jsx("button",{onClick:e=>{e.stopPropagation(),J(t.id)},className:`${t.locked?"text-yellow-600 dark:text-yellow-400":"text-gray-600 dark:text-gray-400"} hover:text-gray-900 dark:hover:text-white`,title:t.locked?"解锁":"锁定",children:s.jsx("span",{className:"material-symbols-outlined text-base",children:t.locked?"lock":"lock_open"})}),s.jsx("span",{className:"material-symbols-outlined text-base text-gray-600 dark:text-gray-400",children:t.type==="image"?"image":"text_fields"}),s.jsxs("span",{className:"flex-1 text-sm font-medium text-gray-900 dark:text-white truncate",children:[t.name,t.locked&&s.jsx("span",{className:"ml-1 text-xs text-yellow-600 dark:text-yellow-400",children:"(锁定)"})]}),s.jsx("button",{onClick:e=>{e.stopPropagation(),K(t.id)},className:"text-red-500 hover:text-red-600",title:"删除",children:s.jsx("span",{className:"material-symbols-outlined text-base",children:"delete"})})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("button",{onClick:e=>{e.stopPropagation(),U(t.id,"up")},className:"px-2 py-1 text-xs border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-800",children:s.jsx("span",{className:"material-symbols-outlined text-sm",children:"arrow_upward"})}),s.jsx("button",{onClick:e=>{e.stopPropagation(),U(t.id,"down")},className:"px-2 py-1 text-xs border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-800",children:s.jsx("span",{className:"material-symbols-outlined text-sm",children:"arrow_downward"})}),s.jsxs("span",{className:"ml-auto text-xs text-gray-500 dark:text-gray-400",children:[Math.round(t.opacity*100),"%"]})]})]},t.id))}),s.jsxs("button",{onClick:()=>{const t=L.current;if(!t)return;const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const a=e.getContext("2d");if(!a)return;[...m].sort((g,o)=>g.zIndex-o.zIndex).forEach(g=>{if(g.visible){if(a.save(),a.globalAlpha=g.opacity,g.type==="image"){const o=g;let y=C.current.get(o.id);y&&(a.translate(o.x+o.width/2,o.y+o.height/2),a.rotate(o.rotation*Math.PI/180),a.drawImage(y,-o.width/2,-o.height/2,o.width,o.height))}else if(g.type==="text"){const o=g;a.translate(o.x,o.y),a.rotate(o.rotation*Math.PI/180),a.font=`${o.fontSize}px ${o.fontFamily}`,a.fillStyle=o.color,a.fillText(o.text,0,0)}a.restore()}});const r=a.getImageData(0,0,e.width,e.height).data;let i=e.width,l=e.height,c=0,x=0;for(let g=0;g<e.height;g++)for(let o=0;o<e.width;o++){const y=(g*e.width+o)*4;r[y+3]>0&&(o<i&&(i=o),o>c&&(c=o),g<l&&(l=g),g>x&&(x=g))}(i>c||l>x)&&(i=0,l=0,c=e.width-1,x=e.height-1);const h=c-i+1,b=x-l+1,k=document.createElement("canvas");k.width=h,k.height=b;const S=k.getContext("2d");S&&(S.drawImage(e,i,l,h,b,0,0,h,b),k.toBlob(g=>{if(!g)return;const o=URL.createObjectURL(g),y=document.createElement("a");y.href=o,y.download=`comparison-${Date.now()}.png`,document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(o)}))},disabled:m.length===0,style:{backgroundColor:"#607AFB"},className:"flex items-center justify-center gap-2 w-full px-4 py-3 rounded-lg text-sm font-semibold text-white shadow hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed",children:[s.jsx("span",{className:"material-symbols-outlined text-base",children:"download"}),"导出画布"]})]})})]})]})})};export{re as default};
