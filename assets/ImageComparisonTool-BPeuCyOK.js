import{r as b,R as V,j as s}from"./index-DBhBG4gC.js";import"./react-vendor-DS08_OVb.js";import"./pdf-vendor-1qLBXhNR.js";const Z=()=>{const[f,k]=b.useState([]),[u,v]=b.useState(null),[_,R]=b.useState(!1),[C,M]=b.useState(null),[z,F]=b.useState(null),[j,q]=b.useState({width:1200,height:800}),I=b.useRef(null),P=b.useRef(null),S=b.useRef(new Map),D=b.useCallback(()=>{const t=I.current;if(!t)return;const e=t.getContext("2d");if(!e)return;e.fillStyle="#f0f0f0",e.fillRect(0,0,t.width,t.height);const a=20;for(let i=0;i<t.width;i+=a)for(let r=0;r<t.height;r+=a)(i/a+r/a)%2===0?e.fillStyle="#ffffff":e.fillStyle="#e0e0e0",e.fillRect(i,r,a,a);[...f].sort((i,r)=>i.zIndex-r.zIndex).forEach(i=>{if(i.visible){if(e.save(),e.globalAlpha=i.opacity,i.type==="image"){const r=i;let n=S.current.get(r.id);if(n||(n=new Image,n.src=r.src,S.current.set(r.id,n)),e.translate(r.x+r.width/2,r.y+r.height/2),e.rotate(r.rotation*Math.PI/180),e.drawImage(n,-r.width/2,-r.height/2,r.width,r.height),u===i.id){e.strokeStyle="#00FF00",e.lineWidth=2,e.strokeRect(-r.width/2,-r.height/2,r.width,r.height);const o=8;e.fillStyle="#00FF00",e.fillRect(-r.width/2-o/2,-r.height/2-o/2,o,o),e.fillRect(r.width/2-o/2,-r.height/2-o/2,o,o),e.fillRect(-r.width/2-o/2,r.height/2-o/2,o,o),e.fillRect(r.width/2-o/2,r.height/2-o/2,o,o)}}else if(i.type==="text"){const r=i;if(e.translate(r.x,r.y),e.rotate(r.rotation*Math.PI/180),e.font=`${r.fontSize}px ${r.fontFamily}`,e.fillStyle=r.color,e.fillText(r.text,0,0),u===i.id){const n=e.measureText(r.text);e.strokeStyle="#00FF00",e.lineWidth=2,e.strokeRect(-5,-r.fontSize-5,n.width+10,r.fontSize+10)}}e.restore()}})},[f,u]);V.useEffect(()=>{D()},[D]);const W=t=>{const e=t.target.files;e&&(Array.from(e).forEach((a,d)=>{const i=new FileReader;i.onload=r=>{var o;const n=new Image;n.onload=()=>{var c;const x=j.width*.8,g=j.height*.8;let h=n.width,p=n.height,w=1;if(h>x||p>g){const l=x/h,y=g/p;w=Math.min(l,y),h=n.width*w,p=n.height*w}const L={id:Date.now().toString()+d,type:"image",name:`图片 ${f.length+d+1}`,src:(c=r.target)==null?void 0:c.result,visible:!0,locked:!1,x:50+d*30,y:50+d*30,width:h,height:p,originalWidth:n.width,originalHeight:n.height,scale:w,rotation:0,opacity:1,zIndex:f.length+d};k(l=>[...l,L]),S.current.set(L.id,n)},n.src=(o=r.target)==null?void 0:o.result},i.readAsDataURL(a)}),t.target.value="")},U=()=>{const t={id:Date.now().toString(),type:"text",name:`文本 ${f.filter(e=>e.type==="text").length+1}`,text:"文本内容",visible:!0,locked:!1,x:j.width/2,y:j.height/2,fontSize:32,fontFamily:"Arial",color:"#000000",rotation:0,opacity:1,zIndex:f.length};k(e=>[...e,t]),v(t.id)},$=t=>{const e=I.current;if(!e)return{x:0,y:0};const a=e.getBoundingClientRect(),d=e.width/a.width,i=e.height/a.height;return{x:(t.clientX-a.left)*d,y:(t.clientY-a.top)*i}},H=(t,e)=>{const a=[...f].sort((d,i)=>i.zIndex-d.zIndex);for(const d of a)if(!(!d.visible||d.locked)){if(d.type==="image"){const i=d;if(t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height)return d}else if(d.type==="text"){const i=d,r=I.current;if(!r)continue;const n=r.getContext("2d");if(!n)continue;n.font=`${i.fontSize}px ${i.fontFamily}`;const o=n.measureText(i.text),x=i.x-5,g=i.y-i.fontSize-5,h=o.width+10,p=i.fontSize+10;if(t>=x&&t<=x+h&&e>=g&&e<=g+p)return d}}return null},T=t=>{const e=$(t),a=H(e.x,e.y);a&&!a.locked?(v(a.id),R(!0),M(e),F({x:a.x,y:a.y})):v(null)},X=t=>{if(!_||!C||!u||!z)return;const e=f.find(r=>r.id===u);if(e!=null&&e.locked)return;const a=$(t),d=a.x-C.x,i=a.y-C.y;k(r=>r.map(n=>n.id===u&&!n.locked?{...n,x:z.x+d,y:z.y+i}:n))},A=()=>{R(!1),M(null),F(null)},Y=t=>{k(e=>e.map(a=>a.id===t?{...a,visible:!a.visible}:a))},B=t=>{k(e=>e.map(a=>{if(a.id===t){const d=!a.locked;return d&&u===t&&v(null),{...a,locked:d}}return a}))},O=t=>{k(e=>e.filter(a=>a.id!==t)),u===t&&v(null)},E=(t,e)=>{k(a=>{if(!a.find(o=>o.id===t))return a;const i=[...a].sort((o,x)=>o.zIndex-x.zIndex),r=i.findIndex(o=>o.id===t);if(r===-1)return a;const n=[...a];if(e==="up"&&r<i.length-1){const o=i[r+1],x=a.findIndex(h=>h.id===t),g=a.findIndex(h=>h.id===o.id);[n[x].zIndex,n[g].zIndex]=[n[g].zIndex,n[x].zIndex]}else if(e==="down"&&r>0){const o=i[r-1],x=a.findIndex(h=>h.id===t),g=a.findIndex(h=>h.id===o.id);[n[x].zIndex,n[g].zIndex]=[n[g].zIndex,n[x].zIndex]}return n})},N=t=>{u&&k(e=>e.map(a=>a.id===u?{...a,...t}:a))},m=f.find(t=>t.id===u);return s.jsx("div",{className:"flex w-full flex-col items-center px-4 py-10 sm:px-6 lg:px-8",children:s.jsxs("div",{className:"flex flex-col gap-8",children:[s.jsxs("div",{className:"flex w-full max-w-7xl flex-col items-center gap-2 text-center mb-8",children:[s.jsx("p",{className:"text-3xl font-black leading-tight tracking-tighter text-gray-900 dark:text-white sm:text-4xl",children:"多图自由拼接"}),s.jsx("p",{className:"text-base font-normal text-gray-500 dark:text-gray-400",children:"在一个画布中导入多张图片，支持图层管理、位置调整和文本添加。"})]}),s.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-[1fr_320px] gap-6 items-start",children:[s.jsxs("div",{className:"rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-background-dark p-6 shadow-sm flex flex-col gap-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"画布"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs("button",{onClick:()=>{var t;return(t=P.current)==null?void 0:t.click()},className:"flex items-center gap-1 px-3 py-1.5 rounded-lg bg-primary text-white text-sm font-medium hover:opacity-90",style:{backgroundColor:"#607AFB"},children:[s.jsx("span",{className:"material-symbols-outlined text-base",children:"add_photo_alternate"}),"添加图片"]}),s.jsxs("button",{onClick:U,className:"flex items-center gap-1 px-3 py-1.5 rounded-lg border border-gray-300 dark:border-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800",children:[s.jsx("span",{className:"material-symbols-outlined text-base",children:"text_fields"}),"添加文本"]}),s.jsx("input",{ref:P,type:"file",accept:"image/*",multiple:!0,onChange:W,className:"hidden"})]})]}),s.jsx("div",{className:"flex-1 flex items-center justify-center bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700 p-4 overflow-auto",children:s.jsx("canvas",{ref:I,width:j.width,height:j.height,onMouseDown:T,onMouseMove:X,onMouseUp:A,onMouseLeave:A,className:"max-w-full max-h-[600px] cursor-move shadow-lg"})}),m&&s.jsxs("div",{className:"p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg space-y-3",children:[s.jsxs("h4",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:["当前选中: ",m.name]}),m.type==="image"&&s.jsx("div",{className:"space-y-2",children:s.jsxs("div",{children:[s.jsxs("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1 block",children:["缩放: ",Math.round(m.scale*100),"%"]}),s.jsx("input",{type:"range",min:"10",max:"200",value:m.scale*100,onChange:t=>{const e=parseFloat(t.target.value)/100,a=m;N({scale:e,width:a.originalWidth*e,height:a.originalHeight*e})},className:"w-full"})]})}),m.type==="text"&&s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{children:[s.jsx("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1 block",children:"文本内容"}),s.jsx("input",{type:"text",value:m.text,onChange:t=>N({text:t.target.value}),className:"w-full px-2 py-1 rounded border border-gray-300 dark:border-gray-700 bg-transparent text-sm",placeholder:"输入文本内容"})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1 block",children:["字体大小: ",m.fontSize,"px"]}),s.jsx("input",{type:"range",min:"12",max:"120",value:m.fontSize,onChange:t=>N({fontSize:parseInt(t.target.value)}),className:"w-full"})]}),s.jsxs("div",{children:[s.jsx("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1 block",children:"颜色"}),s.jsx("input",{type:"color",value:m.color,onChange:t=>N({color:t.target.value}),className:"w-full h-8 rounded cursor-pointer"})]})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1 block",children:["旋转: ",m.rotation,"°"]}),s.jsx("input",{type:"range",min:"0",max:"360",value:m.rotation,onChange:t=>N({rotation:parseInt(t.target.value)}),className:"w-full"})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"text-xs text-gray-600 dark:text-gray-400 mb-1 block",children:["不透明度: ",Math.round(m.opacity*100),"%"]}),s.jsx("input",{type:"range",min:"0",max:"100",value:m.opacity*100,onChange:t=>N({opacity:parseFloat(t.target.value)/100}),className:"w-full"})]})]})]}),s.jsx("div",{className:"rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-background-dark p-6 shadow-sm",children:s.jsxs("div",{className:"flex flex-col gap-4 min-h-[680px]",children:[s.jsx("h3",{className:"text-base font-semibold text-gray-900 dark:text-white",children:"图层"}),f.length===0?s.jsx("div",{className:"flex-1 flex items-center justify-center text-center text-gray-500 dark:text-gray-400 text-sm",children:s.jsxs("div",{className:"space-y-2",children:[s.jsx("span",{className:"material-symbols-outlined text-4xl",children:"layers"}),s.jsx("p",{children:"暂无图层"}),s.jsx("p",{className:"text-xs",children:"点击上方按钮添加图片或文本"})]})}):s.jsx("div",{className:"flex-1 overflow-y-auto space-y-2",children:[...f].sort((t,e)=>e.zIndex-t.zIndex).map(t=>s.jsxs("div",{className:`p-3 rounded-lg border transition-all ${t.locked?"cursor-not-allowed opacity-60":"cursor-pointer"} ${u===t.id?"border-primary bg-primary/10":"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600"}`,onClick:()=>!t.locked&&v(t.id),children:[s.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[s.jsx("button",{onClick:e=>{e.stopPropagation(),Y(t.id)},className:"text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white",title:t.visible?"隐藏":"显示",children:s.jsx("span",{className:"material-symbols-outlined text-base",children:t.visible?"visibility":"visibility_off"})}),s.jsx("button",{onClick:e=>{e.stopPropagation(),B(t.id)},className:`${t.locked?"text-yellow-600 dark:text-yellow-400":"text-gray-600 dark:text-gray-400"} hover:text-gray-900 dark:hover:text-white`,title:t.locked?"解锁":"锁定",children:s.jsx("span",{className:"material-symbols-outlined text-base",children:t.locked?"lock":"lock_open"})}),s.jsx("span",{className:"material-symbols-outlined text-base text-gray-600 dark:text-gray-400",children:t.type==="image"?"image":"text_fields"}),s.jsxs("span",{className:"flex-1 text-sm font-medium text-gray-900 dark:text-white truncate",children:[t.name,t.locked&&s.jsx("span",{className:"ml-1 text-xs text-yellow-600 dark:text-yellow-400",children:"(锁定)"})]}),s.jsx("button",{onClick:e=>{e.stopPropagation(),O(t.id)},className:"text-red-500 hover:text-red-600",title:"删除",children:s.jsx("span",{className:"material-symbols-outlined text-base",children:"delete"})})]}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("button",{onClick:e=>{e.stopPropagation(),E(t.id,"up")},className:"px-2 py-1 text-xs border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-800",children:s.jsx("span",{className:"material-symbols-outlined text-sm",children:"arrow_upward"})}),s.jsx("button",{onClick:e=>{e.stopPropagation(),E(t.id,"down")},className:"px-2 py-1 text-xs border border-gray-300 dark:border-gray-700 rounded hover:bg-gray-100 dark:hover:bg-gray-800",children:s.jsx("span",{className:"material-symbols-outlined text-sm",children:"arrow_downward"})}),s.jsxs("span",{className:"ml-auto text-xs text-gray-500 dark:text-gray-400",children:[Math.round(t.opacity*100),"%"]})]})]},t.id))}),s.jsxs("button",{onClick:()=>{const t=I.current;if(!t)return;const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const a=e.getContext("2d");if(!a)return;[...f].sort((c,l)=>c.zIndex-l.zIndex).forEach(c=>{if(c.visible){if(a.save(),a.globalAlpha=c.opacity,c.type==="image"){const l=c;let y=S.current.get(l.id);y&&(a.translate(l.x+l.width/2,l.y+l.height/2),a.rotate(l.rotation*Math.PI/180),a.drawImage(y,-l.width/2,-l.height/2,l.width,l.height))}else if(c.type==="text"){const l=c;a.translate(l.x,l.y),a.rotate(l.rotation*Math.PI/180),a.font=`${l.fontSize}px ${l.fontFamily}`,a.fillStyle=l.color,a.fillText(l.text,0,0)}a.restore()}});const r=a.getImageData(0,0,e.width,e.height).data;let n=e.width,o=e.height,x=0,g=0;for(let c=0;c<e.height;c++)for(let l=0;l<e.width;l++){const y=(c*e.width+l)*4;r[y+3]>0&&(l<n&&(n=l),l>x&&(x=l),c<o&&(o=c),c>g&&(g=c))}(n>x||o>g)&&(n=0,o=0,x=e.width-1,g=e.height-1);const h=x-n+1,p=g-o+1,w=document.createElement("canvas");w.width=h,w.height=p;const L=w.getContext("2d");L&&(L.drawImage(e,n,o,h,p,0,0,h,p),w.toBlob(c=>{if(!c)return;const l=URL.createObjectURL(c),y=document.createElement("a");y.href=l,y.download=`comparison-${Date.now()}.png`,document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(l)}))},disabled:f.length===0,style:{backgroundColor:"#607AFB"},className:"flex items-center justify-center gap-2 w-full px-4 py-3 rounded-lg text-sm font-semibold text-white shadow hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed",children:[s.jsx("span",{className:"material-symbols-outlined text-base",children:"download"}),"导出画布"]})]})})]})]})})};export{Z as default};
