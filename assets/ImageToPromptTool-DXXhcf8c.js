import{r as s,j as e}from"./index-BcR3zBF8.js";import"./react-vendor-DS08_OVb.js";import"./pdf-vendor-B1Z1FYJ2.js";const k=(()=>{try{return"gpu"in navigator}catch{return!1}})(),z=[{value:"<CAPTION>",label:"简短描述",description:"生成简洁的图片描述"},{value:"<DETAILED_CAPTION>",label:"详细描述",description:"生成较详细的图片描述"},{value:"<MORE_DETAILED_CAPTION>",label:"完整描述",description:"生成完整详细的描述，适合作为 AI 绘画提示词"}],Q=()=>{const[b,N]=s.useState(null),[T,v]=s.useState(""),[a,p]=s.useState("idle"),[R,C]=s.useState(""),[f,A]=s.useState([]),[d,_]=s.useState("<DETAILED_CAPTION>"),[g,j]=s.useState(""),[I,S]=s.useState(0),[P,D]=s.useState(!1),[E,x]=s.useState(null),n=s.useRef(null);s.useEffect(()=>{if(!k)return;const t="/FreeTool/florence2.worker.js".replace(/\/+/g,"/"),l=new Worker(t,{type:"module"});return l.onmessage=o=>{const{status:i,data:m,progress:c,file:u,loaded:F,total:O,result:w,time:J}=o.data;if(i==="loading")C(m);else if(i==="progress")A(h=>h.find(y=>y.file===u)?h.map(y=>y.file===u?{...y,progress:c,loaded:F,total:O}:y):[...h,{file:u,progress:c,loaded:F,total:O}]);else if(i==="ready")p("ready"),C(""),A([]);else if(i==="complete"){p("ready");const h=w[d]||Object.values(w)[0]||JSON.stringify(w);j(h),S(J)}},l.onerror=o=>{console.error("Worker error:",o),x("模型加载失败，请刷新页面重试"),p("idle")},n.current=l,()=>{l.terminate()}},[d]);const L=s.useCallback(r=>{var o;const t=(o=r.target.files)==null?void 0:o[0];if(!t)return;if(!t.type.startsWith("image/")){x("请选择图片文件");return}x(null),j(""),v(t.name);const l=new FileReader;l.onload=i=>{var c,u;const m=(c=i.target)==null?void 0:c.result;N(m),(u=n.current)==null||u.postMessage({type:"reset"})},l.readAsDataURL(t)},[]),U=s.useCallback(r=>{r.preventDefault();const t=r.dataTransfer.files[0];if(!t||!t.type.startsWith("image/")){x("请拖入图片文件");return}x(null),j(""),v(t.name);const l=new FileReader;l.onload=o=>{var m,c;const i=(m=o.target)==null?void 0:m.result;N(i),(c=n.current)==null||c.postMessage({type:"reset"})},l.readAsDataURL(t)},[]),W=s.useCallback(()=>{n.current&&(p("loading"),x(null),n.current.postMessage({type:"load"}))},[]),B=s.useCallback(()=>{!n.current||!b||a!=="ready"||(p("processing"),x(null),n.current.postMessage({type:"run",data:{url:b,task:d}}))},[b,a,d]),G=s.useCallback(async()=>{if(g)try{await navigator.clipboard.writeText(g),D(!0),setTimeout(()=>D(!1),2e3)}catch(r){console.error("复制失败:",r)}},[g]),$=s.useCallback(()=>{var r;N(null),v(""),j(""),S(0),(r=n.current)==null||r.postMessage({type:"reset"})},[]),M=f.length>0?f.reduce((r,t)=>r+(t.progress||0),0)/f.length:0;return e.jsxs("div",{className:"flex w-full flex-col items-center px-4 py-10 sm:px-6 lg:px-8",children:[e.jsxs("div",{className:"flex w-full max-w-6xl flex-col items-center gap-2 text-center mb-8",children:[e.jsx("p",{className:"text-3xl font-black leading-tight tracking-tighter text-gray-900 dark:text-white sm:text-4xl",children:"图片转提示词"}),e.jsx("p",{className:"text-base font-normal text-gray-500 dark:text-gray-400",children:"使用 AI 从图片生成描述文本，可用作 Stable Diffusion 等 AI 绘画的提示词"})]}),e.jsxs("div",{className:"w-full max-w-6xl flex flex-col gap-6",children:[!k&&e.jsxs("div",{className:"bg-red-100 dark:bg-red-900/50 border border-red-200 dark:border-red-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-red-600 dark:text-red-400",children:"error"}),e.jsx("p",{className:"text-red-800 dark:text-red-300 text-sm font-medium",children:"您的浏览器不支持 WebGPU，无法使用此功能"})]}),e.jsx("p",{className:"text-red-700 dark:text-red-400 text-xs mt-2",children:"请使用最新版本的 Chrome、Edge 或其他支持 WebGPU 的浏览器"})]}),E&&e.jsx("div",{className:"bg-red-100 dark:bg-red-900/50 border border-red-200 dark:border-red-800 rounded-lg p-4",children:e.jsx("p",{className:"text-red-800 dark:text-red-300 text-sm",children:E})}),e.jsx("div",{className:"w-full rounded-xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-background-dark shadow-sm",children:b?e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2",children:[e.jsxs("div",{className:"relative flex flex-col p-6 border-b lg:border-b-0 lg:border-r border-gray-200 dark:border-gray-700/50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-gray-900 dark:text-white text-base font-semibold leading-normal flex items-center gap-2",children:[e.jsx("span",{className:"material-symbols-outlined text-xl",children:"image"}),"上传的图片"]}),e.jsx("button",{onClick:$,className:"text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300",children:"更换图片"})]}),e.jsx("div",{className:"flex-1 flex items-center justify-center bg-gray-50 dark:bg-gray-900/50 rounded-lg border border-gray-200 dark:border-gray-700 p-4 min-h-[300px]",children:e.jsx("img",{src:b,alt:"Preview",className:"max-w-full max-h-[400px] object-contain"})}),T&&e.jsx("p",{className:"mt-2 text-xs text-gray-500 dark:text-gray-400 text-center",children:T})]}),e.jsxs("div",{className:"relative flex flex-col p-6 bg-gray-50/50 dark:bg-gray-800/30 gap-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"px-1 text-base font-bold text-gray-900 dark:text-white",children:"描述类型"}),e.jsx("div",{className:"flex flex-col gap-2",children:z.map(r=>e.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all border ${d===r.value?"border-primary bg-primary/5 dark:bg-primary/10":"border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700/50"}`,children:[e.jsx("input",{type:"radio",name:"taskType",value:r.value,checked:d===r.value,onChange:t=>_(t.target.value),className:"sr-only"}),e.jsx("div",{className:`w-4 h-4 rounded-full border-2 flex items-center justify-center ${d===r.value?"border-primary":"border-gray-400 dark:border-gray-500"}`,children:d===r.value&&e.jsx("div",{className:"w-2 h-2 rounded-full bg-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 dark:text-white",children:r.label}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:r.description})]})]},r.value))})]}),a==="loading"&&e.jsxs("div",{className:"space-y-3 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"spinner",style:{borderTopColor:"#607AFB"}}),e.jsx("span",{className:"text-sm text-blue-700 dark:text-blue-300",children:R||"正在加载模型..."})]}),f.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"w-full h-2 bg-blue-200 dark:bg-blue-800 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary transition-all duration-300",style:{width:`${M}%`}})}),e.jsxs("p",{className:"text-xs text-blue-600 dark:text-blue-400",children:[Math.round(M),"% - 首次加载约需下载 500MB 模型文件"]})]})]}),e.jsxs("div",{className:"flex flex-col gap-3",children:[a==="idle"&&e.jsxs("button",{onClick:W,disabled:!k,style:{backgroundColor:"#607AFB"},className:"flex h-11 w-full cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg px-6 text-sm font-bold text-white shadow-lg transition-opacity hover:opacity-90 disabled:cursor-not-allowed disabled:opacity-50",children:[e.jsx("span",{className:"material-symbols-outlined",children:"download"}),e.jsx("span",{children:"加载 AI 模型"})]}),(a==="ready"||a==="processing")&&e.jsx("button",{onClick:B,disabled:a==="processing",style:{backgroundColor:"#607AFB"},className:"flex h-11 w-full cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg px-6 text-sm font-bold text-white shadow-lg transition-opacity hover:opacity-90 disabled:cursor-not-allowed disabled:opacity-50",children:a==="processing"?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"spinner"}),e.jsx("span",{children:"生成中..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"material-symbols-outlined",children:"auto_awesome"}),e.jsx("span",{children:"生成描述"})]})})]}),g&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 dark:text-white",children:"生成结果"}),I>0&&e.jsxs("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:["耗时: ",(I/1e3).toFixed(2),"s"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{readOnly:!0,value:g,className:"w-full h-32 p-3 text-sm bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-primary"}),e.jsx("button",{onClick:G,className:"absolute top-2 right-2 p-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",title:"复制",children:e.jsx("span",{className:"material-symbols-outlined text-lg text-gray-600 dark:text-gray-300",children:P?"check":"content_copy"})})]}),P&&e.jsx("p",{className:"text-xs text-green-600 dark:text-green-400",children:"已复制到剪贴板"})]}),a==="idle"&&e.jsx("div",{className:"p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg",children:e.jsxs("p",{className:"text-xs text-amber-700 dark:text-amber-300",children:[e.jsx("strong",{children:"提示："}),"首次使用需要下载约 500MB 的 AI 模型，模型会缓存到浏览器中，后续使用无需重复下载。"]})}),a==="ready"&&!g&&e.jsx("div",{className:"p-3 bg-green-50 dark:bg-green-900/20 rounded-lg",children:e.jsxs("p",{className:"text-xs text-green-700 dark:text-green-300",children:[e.jsx("strong",{children:"模型已就绪！"}),'选择描述类型后点击"生成描述"按钮。']})})]})]}):e.jsxs("label",{className:"flex flex-col items-center gap-6 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-700 p-8 sm:p-14 text-center cursor-pointer hover:border-primary dark:hover:border-primary transition-colors m-6",onDragOver:r=>r.preventDefault(),onDrop:U,children:[e.jsx("span",{className:"material-symbols-outlined text-5xl text-gray-400 dark:text-gray-500",children:"add_photo_alternate"}),e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("p",{className:"text-lg font-bold text-gray-900 dark:text-white",children:"拖拽图片至此"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"支持 JPG, PNG, WebP 等格式"})]}),e.jsx("span",{className:"flex h-10 min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-gray-100 dark:bg-white/10 px-4 text-sm font-bold text-gray-800 dark:text-white transition-colors hover:bg-gray-200 dark:hover:bg-white/20",children:"点击选择文件"}),e.jsx("input",{type:"file",accept:"image/*",onChange:L,className:"hidden",disabled:!k})]})})]})]})};export{Q as default};
