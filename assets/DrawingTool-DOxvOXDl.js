import{r as i,j as r}from"./index-BcR3zBF8.js";import"./react-vendor-DS08_OVb.js";import"./pdf-vendor-B1Z1FYJ2.js";const ge="freetool-drawing-data",Q=()=>Math.random().toString(36).substring(2,11),We=()=>{try{const d=localStorage.getItem(ge);if(d)return JSON.parse(d)}catch(d){console.error("Failed to load drawing data:",d)}return null},Le=d=>{try{localStorage.setItem(ge,JSON.stringify(d))}catch(b){console.error("Failed to save drawing data:",b)}},Xe=()=>{const[d,b]=i.useState(()=>We()||{shapes:[]}),[u,Z]=i.useState("select"),[g,M]=i.useState(null),[D,K]=i.useState(!1),[q,ee]=i.useState(null),[k,C]=i.useState(null),[W,te]=i.useState("#FFFFFF"),[L,ye]=i.useState("#000000"),[I,ue]=i.useState(2),[f,B]=i.useState(1),[h,re]=i.useState({x:0,y:0}),[T,ne]=i.useState(!1),[G,he]=i.useState({x:0,y:0}),[S,N]=i.useState(null),[A,E]=i.useState(""),[fe,se]=i.useState(!1),[F,ie]=i.useState(!1),[J,me]=i.useState({x:0,y:0}),[O,le]=i.useState(null),oe=i.useRef(null),V=i.useRef(null),Y=i.useRef(null);i.useEffect(()=>{Le(d)},[d]),i.useEffect(()=>{if(O){const e=d.shapes.find(t=>t.id===O);e&&(N(O),E(e.text),le(null),setTimeout(()=>{var t,n;(t=Y.current)==null||t.focus(),(n=Y.current)==null||n.select()},0))}},[d.shapes,O]);const p=i.useCallback(e=>{var n;const t=(n=oe.current)==null?void 0:n.getBoundingClientRect();return t?{x:(e.clientX-t.left-h.x)/f,y:(e.clientY-t.top-h.y)/f}:{x:0,y:0}},[h,f]),ae=i.useCallback((e,t,n)=>{const s=Math.min(t.x,n.x),l=Math.min(t.y,n.y),o=Math.abs(n.x-t.x),x=Math.abs(n.y-t.y),c={id:Q(),type:e,x:s,y:l,width:Math.max(o,10),height:Math.max(x,10),rotation:0,fill:e==="line"||e==="arrowLine"||e==="freehand"?"transparent":W,stroke:L,strokeWidth:I,text:e==="text"?"文本":""};if((e==="line"||e==="arrowLine")&&(c.x=t.x,c.y=t.y,c.endX=n.x,c.endY=n.y,c.width=0,c.height=0),e==="circle"){const y=Math.max(o,x);c.width=y,c.height=y}return c},[W,L,I]),be=i.useCallback(e=>{const t=p(e);if(e.button===1||e.button===0&&e.altKey){ne(!0),he({x:e.clientX-h.x,y:e.clientY-h.y});return}if(u==="select"){const n=[...d.shapes].reverse().find(s=>{if(s.type==="line"||s.type==="arrowLine"){const l=(s.endX||0)-s.x,o=(s.endY||0)-s.y,x=Math.sqrt(l*l+o*o);if(x===0)return!1;const c=Math.max(0,Math.min(1,((t.x-s.x)*l+(t.y-s.y)*o)/(x*x))),y=s.x+c*l,w=s.y+c*o;return Math.sqrt((t.x-y)**2+(t.y-w)**2)<10}return t.x>=s.x&&t.x<=s.x+s.width&&t.y>=s.y&&t.y<=s.y+s.height});n?(M(n.id),ie(!0),me({x:t.x-n.x,y:t.y-n.y})):M(null);return}if(u==="freehand"){const n={id:Q(),type:"freehand",x:t.x,y:t.y,width:0,height:0,rotation:0,fill:"transparent",stroke:L,strokeWidth:I,text:"",points:[{x:t.x,y:t.y}]};C(n),K(!0);return}K(!0),ee(t),C(null)},[u,p,d.shapes,h,L,I]),ke=i.useCallback(e=>{if(T){re({x:e.clientX-G.x,y:e.clientY-G.y});return}if(F&&g){const n=p(e);b(s=>({shapes:s.shapes.map(l=>{if(l.id===g){const o=n.x-J.x,x=n.y-J.y;if(l.type==="line"||l.type==="arrowLine"){const c=(l.endX||0)-l.x,y=(l.endY||0)-l.y;return{...l,x:o,y:x,endX:o+c,endY:x+y}}return{...l,x:o,y:x}}return l})}));return}if(!D)return;const t=p(e);if(u==="freehand"&&k){C(n=>!n||!n.points?n:{...n,points:[...n.points,{x:t.x,y:t.y}]});return}if(q&&u!=="select"){const n=ae(u,q,t);C(n)}},[T,G,F,g,J,D,p,u,k,q,ae]),ce=i.useCallback(()=>{if(T){ne(!1);return}if(F){ie(!1);return}D&&k&&(b(e=>({shapes:[...e.shapes,k]})),k.type==="text"&&le(k.id)),K(!1),ee(null),C(null)},[T,F,D,k]),we=i.useCallback(e=>{if(u!=="select")return;const t=p(e),n=[...d.shapes].reverse().find(s=>s.type==="line"||s.type==="arrowLine"||s.type==="freehand"?!1:t.x>=s.x&&t.x<=s.x+s.width&&t.y>=s.y&&t.y<=s.y+s.height);n&&(n.type==="text"?(N(n.id),E(n.text),setTimeout(()=>{var s;return(s=Y.current)==null?void 0:s.focus()},0)):(N(n.id),E(n.text||""),setTimeout(()=>{var s;return(s=Y.current)==null?void 0:s.focus()},0)))},[u,p,d.shapes]),je=i.useCallback(e=>{e.preventDefault();const t=e.deltaY>0?.9:1.1;B(n=>Math.max(.25,Math.min(4,n*t)))},[]),H=i.useCallback(()=>{g&&(b(e=>({shapes:e.shapes.filter(t=>t.id!==g)})),M(null))},[g]);i.useEffect(()=>{const e=t=>{(t.key==="Delete"||t.key==="Backspace")&&(S||H()),t.key==="Escape"&&(M(null),Z("select"),N(null))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[H,S]);const de=i.useCallback(()=>{S&&A.trim()&&b(e=>({shapes:e.shapes.map(t=>t.id===S?{...t,text:A.trim()}:t)})),N(null),E("")},[S,A]),ve=i.useCallback(()=>{if(g){const e=d.shapes.find(t=>t.id===g);if(e){const t={...e,id:Q(),x:e.x+20,y:e.y+20};b(n=>({shapes:[...n.shapes,t]})),M(t.id)}}},[g,d.shapes]),P=i.useCallback(e=>{g&&b(t=>({shapes:t.shapes.map(n=>n.id===g?{...n,...e}:n)}))},[g]),Se=i.useCallback(()=>{if(!V.current||d.shapes.length===0)return;let e=1/0,t=1/0,n=-1/0,s=-1/0;d.shapes.forEach(a=>{a.type==="line"||a.type==="arrowLine"?(e=Math.min(e,a.x,a.endX||0),t=Math.min(t,a.y,a.endY||0),n=Math.max(n,a.x,a.endX||0),s=Math.max(s,a.y,a.endY||0)):a.type==="freehand"&&a.points?a.points.forEach(m=>{e=Math.min(e,m.x),t=Math.min(t,m.y),n=Math.max(n,m.x),s=Math.max(s,m.y)}):(e=Math.min(e,a.x),t=Math.min(t,a.y),n=Math.max(n,a.x+a.width),s=Math.max(s,a.y+a.height))});const l=20,o=n-e+l*2,x=s-t+l*2,c=V.current.cloneNode(!0);c.setAttribute("width",String(o)),c.setAttribute("height",String(x)),c.setAttribute("viewBox",`${e-l} ${t-l} ${o} ${x}`),c.style.transform="";const y=document.createElementNS("http://www.w3.org/2000/svg","rect");y.setAttribute("x",String(e-l)),y.setAttribute("y",String(t-l)),y.setAttribute("width",String(o)),y.setAttribute("height",String(x)),y.setAttribute("fill","white"),c.insertBefore(y,c.firstChild);const w=new XMLSerializer().serializeToString(c),j=new Blob([w],{type:"image/svg+xml;charset=utf-8"}),$=URL.createObjectURL(j),v=new Image;v.onload=()=>{const a=document.createElement("canvas"),m=2;a.width=o*m,a.height=x*m;const X=a.getContext("2d");X&&(X.scale(m,m),X.drawImage(v,0,0),a.toBlob(U=>{if(U){const z=URL.createObjectURL(U),R=document.createElement("a");R.href=z,R.download="drawing.png",R.click(),URL.revokeObjectURL(z)}},"image/png")),URL.revokeObjectURL($)},v.src=$,se(!0),setTimeout(()=>se(!1),2e3)},[d.shapes]),pe=i.useCallback(()=>{b({shapes:[]}),M(null)},[]),$e=i.useCallback(()=>{B(1),re({x:0,y:0})},[]),xe=(e,t=!1)=>{const n=e.id===g&&!t,s=t?`preview-${e.id}`:e.id,l={fill:e.fill==="transparent"?"none":e.fill,stroke:e.stroke,strokeWidth:e.strokeWidth,style:{cursor:u==="select"?"move":"crosshair"}};let o=null;switch(e.type){case"rectangle":o=r.jsx("rect",{x:e.x,y:e.y,width:e.width,height:e.height,...l});break;case"roundedRect":o=r.jsx("rect",{x:e.x,y:e.y,width:e.width,height:e.height,rx:10,...l});break;case"circle":o=r.jsx("circle",{cx:e.x+e.width/2,cy:e.y+e.height/2,r:e.width/2,...l});break;case"ellipse":o=r.jsx("ellipse",{cx:e.x+e.width/2,cy:e.y+e.height/2,rx:e.width/2,ry:e.height/2,...l});break;case"diamond":const c=e.x+e.width/2,y=e.y+e.height/2;o=r.jsx("polygon",{points:`${c},${e.y} ${e.x+e.width},${y} ${c},${e.y+e.height} ${e.x},${y}`,...l});break;case"triangle":o=r.jsx("polygon",{points:`${e.x+e.width/2},${e.y} ${e.x+e.width},${e.y+e.height} ${e.x},${e.y+e.height}`,...l});break;case"arrow":const w=e.width,j=e.height;o=r.jsx("polygon",{points:`${e.x},${e.y+j*.3} ${e.x+w*.6},${e.y+j*.3} ${e.x+w*.6},${e.y} ${e.x+w},${e.y+j*.5} ${e.x+w*.6},${e.y+j} ${e.x+w*.6},${e.y+j*.7} ${e.x},${e.y+j*.7}`,...l});break;case"line":o=r.jsx("line",{x1:e.x,y1:e.y,x2:e.endX,y2:e.endY,...l});break;case"arrowLine":const $=Math.atan2((e.endY||0)-e.y,(e.endX||0)-e.x),v=12,a=(e.endX||0)-v*Math.cos($-Math.PI/6),m=(e.endY||0)-v*Math.sin($-Math.PI/6),X=(e.endX||0)-v*Math.cos($+Math.PI/6),U=(e.endY||0)-v*Math.sin($+Math.PI/6);o=r.jsxs("g",{children:[r.jsx("line",{x1:e.x,y1:e.y,x2:e.endX,y2:e.endY,...l}),r.jsx("polygon",{points:`${e.endX},${e.endY} ${a},${m} ${X},${U}`,fill:e.stroke,stroke:"none"})]});break;case"text":o=r.jsxs("g",{children:[r.jsx("rect",{x:e.x,y:e.y,width:e.width,height:e.height,fill:"transparent",stroke:n?e.stroke:"transparent",strokeWidth:1,strokeDasharray:"4"}),r.jsx("text",{x:e.x+e.width/2,y:e.y+e.height/2+5,textAnchor:"middle",fill:e.stroke,fontSize:"16",fontFamily:"system-ui",children:e.text})]});break;case"freehand":if(e.points&&e.points.length>1){const z=e.points.reduce((R,_,Ce)=>R+(Ce===0?`M ${_.x} ${_.y}`:` L ${_.x} ${_.y}`),"");o=r.jsx("path",{d:z,fill:"none",stroke:e.stroke,strokeWidth:e.strokeWidth,strokeLinecap:"round",strokeLinejoin:"round"})}break}if(!o)return null;const x=e.type!=="text"&&e.type!=="line"&&e.type!=="arrowLine"&&e.type!=="freehand"&&e.text;return r.jsxs("g",{children:[o,x&&r.jsx("text",{x:e.x+e.width/2,y:e.y+e.height/2+5,textAnchor:"middle",fill:e.stroke,fontSize:"14",fontFamily:"system-ui",style:{pointerEvents:"none"},children:e.text}),n&&e.type!=="line"&&e.type!=="arrowLine"&&e.type!=="freehand"&&r.jsx("rect",{x:e.x-4,y:e.y-4,width:e.width+8,height:e.height+8,fill:"none",stroke:"#607AFB",strokeWidth:2,strokeDasharray:"4"})]},s)},Me=({type:e,className:t="w-5 h-5"})=>{const n="currentColor";switch(e){case"select":return r.jsx("span",{className:"material-symbols-outlined text-xl",children:"arrow_selector_tool"});case"rectangle":return r.jsx("svg",{className:t,viewBox:"0 0 20 20",fill:"none",stroke:n,strokeWidth:1.5,children:r.jsx("rect",{x:"3",y:"5",width:"14",height:"10"})});case"roundedRect":return r.jsx("svg",{className:t,viewBox:"0 0 20 20",fill:"none",stroke:n,strokeWidth:1.5,children:r.jsx("rect",{x:"3",y:"5",width:"14",height:"10",rx:"3"})});case"circle":return r.jsx("svg",{className:t,viewBox:"0 0 20 20",fill:"none",stroke:n,strokeWidth:1.5,children:r.jsx("circle",{cx:"10",cy:"10",r:"6"})});case"ellipse":return r.jsx("svg",{className:t,viewBox:"0 0 20 20",fill:"none",stroke:n,strokeWidth:1.5,children:r.jsx("ellipse",{cx:"10",cy:"10",rx:"7",ry:"5"})});case"diamond":return r.jsx("svg",{className:t,viewBox:"0 0 20 20",fill:"none",stroke:n,strokeWidth:1.5,children:r.jsx("polygon",{points:"10,3 17,10 10,17 3,10"})});case"triangle":return r.jsx("svg",{className:t,viewBox:"0 0 20 20",fill:"none",stroke:n,strokeWidth:1.5,children:r.jsx("polygon",{points:"10,4 17,16 3,16"})});case"arrow":return r.jsx("svg",{className:t,viewBox:"0 0 20 20",fill:"none",stroke:n,strokeWidth:1.5,children:r.jsx("polygon",{points:"3,7 12,7 12,4 18,10 12,16 12,13 3,13"})});case"line":return r.jsx("svg",{className:t,viewBox:"0 0 20 20",fill:"none",stroke:n,strokeWidth:1.5,children:r.jsx("line",{x1:"3",y1:"17",x2:"17",y2:"3"})});case"arrowLine":return r.jsxs("svg",{className:t,viewBox:"0 0 20 20",fill:"none",stroke:n,strokeWidth:1.5,children:[r.jsx("line",{x1:"3",y1:"17",x2:"17",y2:"3"}),r.jsx("polyline",{points:"11,3 17,3 17,9"})]});case"text":return r.jsx("span",{className:"material-symbols-outlined text-xl",children:"title"});case"freehand":return r.jsx("span",{className:"material-symbols-outlined text-xl",children:"draw"});default:return null}},Ne=[{id:"select",label:"选择"},{id:"rectangle",label:"矩形"},{id:"roundedRect",label:"圆角矩形"},{id:"circle",label:"圆形"},{id:"ellipse",label:"椭圆"},{id:"diamond",label:"菱形"},{id:"triangle",label:"三角形"},{id:"arrow",label:"箭头"},{id:"line",label:"直线"},{id:"arrowLine",label:"箭头线"},{id:"text",label:"文本"},{id:"freehand",label:"画笔"}];return d.shapes.find(e=>e.id===g),r.jsxs("div",{className:"flex w-full flex-col items-center px-4 py-6 sm:px-6 lg:px-8",children:[r.jsxs("div",{className:"flex w-full max-w-7xl flex-col items-center gap-2 text-center mb-6",children:[r.jsx("p",{className:"text-3xl font-black leading-tight tracking-tighter text-gray-900 dark:text-white sm:text-4xl",children:"绘图画布"}),r.jsx("p",{className:"text-base font-normal text-gray-500 dark:text-gray-400",children:"在线绘制流程图、示意图，支持多种形状和连接线"})]}),fe&&r.jsx("div",{className:"fixed top-8 left-1/2 -translate-x-1/2 z-50 animate-fade-in-down",children:r.jsxs("div",{className:"bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2",children:[r.jsx("span",{className:"material-symbols-outlined text-xl",children:"check_circle"}),r.jsx("span",{className:"font-medium",children:"导出成功!"})]})}),r.jsxs("div",{className:"w-full max-w-7xl",children:[r.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-t-xl border border-b-0 border-gray-200 dark:border-gray-700 p-2 flex flex-wrap items-center gap-1",children:[Ne.map(e=>r.jsx("button",{onClick:()=>Z(e.id),className:`p-2 rounded transition-colors ${u===e.id?"bg-primary text-white":"hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400"}`,title:e.label,children:r.jsx(Me,{type:e.id})},e.id)),r.jsx("div",{className:"h-6 w-px bg-gray-200 dark:bg-gray-700 mx-2"}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:"填充"}),r.jsx("div",{className:"relative",children:r.jsx("input",{type:"color",value:W==="transparent"?"#ffffff":W,onChange:e=>{te(e.target.value),P({fill:e.target.value})},className:"w-6 h-6 rounded cursor-pointer border border-gray-300"})}),r.jsx("button",{onClick:()=>{te("transparent"),P({fill:"transparent"})},className:`w-6 h-6 rounded border ${W==="transparent"?"ring-2 ring-primary":"border-gray-300"}`,style:{background:"repeating-conic-gradient(#ccc 0% 25%, white 0% 50%) 50% / 8px 8px"},title:"透明"})]}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:"边框"}),r.jsx("input",{type:"color",value:L,onChange:e=>{ye(e.target.value),P({stroke:e.target.value})},className:"w-6 h-6 rounded cursor-pointer border border-gray-300"})]}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("span",{className:"text-xs text-gray-500 dark:text-gray-400",children:"粗细"}),r.jsx("select",{value:I,onChange:e=>{const t=Number(e.target.value);ue(t),P({strokeWidth:t})},className:"text-xs px-1 py-0.5 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700",children:[1,2,3,4,5,6].map(e=>r.jsxs("option",{value:e,children:[e,"px"]},e))})]})]}),r.jsx("div",{className:"flex-1"}),r.jsx("button",{onClick:ve,disabled:!g,className:"p-2 rounded transition-colors hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400 disabled:opacity-50",title:"复制",children:r.jsx("span",{className:"material-symbols-outlined text-xl",children:"content_copy"})}),r.jsx("button",{onClick:H,disabled:!g,className:"p-2 rounded transition-colors hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-400 disabled:opacity-50",title:"删除",children:r.jsx("span",{className:"material-symbols-outlined text-xl",children:"delete"})}),r.jsx("div",{className:"h-6 w-px bg-gray-200 dark:bg-gray-700 mx-2"}),r.jsxs("div",{className:"flex items-center gap-1",children:[r.jsx("button",{onClick:()=>B(e=>Math.min(4,e*1.2)),className:"p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors",title:"放大",children:r.jsx("span",{className:"material-symbols-outlined text-base",children:"zoom_in"})}),r.jsxs("span",{className:"w-12 text-center text-xs text-gray-500",children:[Math.round(f*100),"%"]}),r.jsx("button",{onClick:()=>B(e=>Math.max(.25,e/1.2)),className:"p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors",title:"缩小",children:r.jsx("span",{className:"material-symbols-outlined text-base",children:"zoom_out"})}),r.jsx("button",{onClick:$e,className:"p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors",title:"重置视图",children:r.jsx("span",{className:"material-symbols-outlined text-base",children:"fit_screen"})})]}),r.jsx("div",{className:"h-6 w-px bg-gray-200 dark:bg-gray-700 mx-2"}),r.jsxs("button",{onClick:pe,className:"flex items-center gap-1 px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors",children:[r.jsx("span",{className:"material-symbols-outlined text-base",children:"restart_alt"}),"清空"]}),r.jsxs("button",{onClick:Se,disabled:d.shapes.length===0,className:"flex items-center gap-1 px-3 py-1.5 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded text-sm hover:bg-green-200 dark:hover:bg-green-900/50 transition-colors disabled:opacity-50",children:[r.jsx("span",{className:"material-symbols-outlined text-base",children:"download"}),"导出"]})]}),r.jsxs("div",{ref:oe,className:"relative bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-b-xl overflow-hidden",style:{height:"600px",cursor:u==="select"?"default":"crosshair"},onMouseDown:be,onMouseMove:ke,onMouseUp:ce,onMouseLeave:ce,onDoubleClick:we,onWheel:je,children:[r.jsx("div",{className:"absolute inset-0 opacity-30 dark:opacity-10",style:{backgroundImage:`
                                linear-gradient(to right, #e5e7eb 1px, transparent 1px),
                                linear-gradient(to bottom, #e5e7eb 1px, transparent 1px)
                            `,backgroundSize:`${20*f}px ${20*f}px`,backgroundPosition:`${h.x}px ${h.y}px`}}),r.jsxs("svg",{ref:V,className:"absolute inset-0 w-full h-full",style:{transform:`translate(${h.x}px, ${h.y}px) scale(${f})`,transformOrigin:"0 0"},children:[d.shapes.map(e=>xe(e)),k&&xe(k,!0)]}),S&&(()=>{const e=d.shapes.find(t=>t.id===S);return e?r.jsx("input",{ref:Y,type:"text",value:A,onChange:t=>E(t.target.value),onBlur:de,onKeyDown:t=>{t.key==="Enter"&&de(),t.key==="Escape"&&N(null)},className:"absolute bg-white dark:bg-gray-800 border-2 border-primary rounded px-2 py-1 text-sm outline-none shadow-lg",style:{left:h.x+e.x*f,top:h.y+e.y*f,width:Math.max(120,e.width*f),transform:"translateY(-50%)",marginTop:e.height*f/2},placeholder:"输入文本..."}):null})(),r.jsxs("div",{className:"absolute bottom-4 left-4 text-xs text-gray-400 dark:text-gray-500 space-y-1",children:[r.jsx("p",{children:"滚轮缩放 | Alt+拖拽移动画布 | Delete删除"}),r.jsx("p",{children:"选择工具可拖拽移动形状"})]})]})]})]})};export{Xe as default};
